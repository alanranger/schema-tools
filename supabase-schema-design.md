# Supabase Schema Design for Schema Tools

This document outlines the database schema design for storing schema validation and enhancement results in Supabase (optional feature).

## Tables

### 1. `scans` table

Stores metadata about each validation/enhancement scan session.

```sql
CREATE TABLE scans (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  timestamp TIMESTAMPTZ DEFAULT NOW(),
  agent VARCHAR(50) NOT NULL, -- 'validator' or 'enhancer'
  total_urls INTEGER DEFAULT 0,
  valid_count INTEGER DEFAULT 0,
  invalid_count INTEGER DEFAULT 0,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_scans_timestamp ON scans(timestamp DESC);
CREATE INDEX idx_scans_agent ON scans(agent);
```

### 2. `urls` table

Stores validation results for each URL.

```sql
CREATE TABLE urls (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  scan_id UUID REFERENCES scans(id) ON DELETE CASCADE,
  url TEXT NOT NULL,
  schema_found BOOLEAN DEFAULT FALSE,
  schema_type TEXT[], -- Array of schema types: ['Product', 'Event']
  valid BOOLEAN DEFAULT FALSE,
  missing_fields TEXT[], -- Array of missing field names
  warnings TEXT[], -- Array of warning messages
  error TEXT,
  validator_links JSONB, -- { schema: '...', google: '...' }
  page_analysis JSONB, -- { jsonLdCount: 2, microdata: true }
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_urls_scan_id ON urls(scan_id);
CREATE INDEX idx_urls_url ON urls(url);
CREATE INDEX idx_urls_valid ON urls(valid);
CREATE INDEX idx_urls_schema_type ON urls USING GIN(schema_type);
```

### 3. `suggestions` table

Stores enhanced schema suggestions generated by the enhancer.

```sql
CREATE TABLE suggestions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  url_id UUID REFERENCES urls(id) ON DELETE CASCADE,
  scan_id UUID REFERENCES scans(id) ON DELETE CASCADE,
  proposed_json JSONB NOT NULL, -- The enhanced schema JSON
  original_json JSONB, -- Original schema if available
  added_fields TEXT[], -- Fields that were added
  notes TEXT[],
  version INTEGER DEFAULT 1, -- Version number for tracking changes
  applied BOOLEAN DEFAULT FALSE, -- Whether this suggestion was applied
  applied_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_suggestions_url_id ON suggestions(url_id);
CREATE INDEX idx_suggestions_scan_id ON suggestions(scan_id);
CREATE INDEX idx_suggestions_applied ON suggestions(applied);
CREATE INDEX idx_suggestions_version ON suggestions(version);
```

### 4. `schema_history` table (optional)

Tracks changes to schemas over time.

```sql
CREATE TABLE schema_history (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  url TEXT NOT NULL,
  schema_json JSONB NOT NULL,
  version INTEGER DEFAULT 1,
  change_type VARCHAR(20), -- 'created', 'updated', 'enhanced'
  change_notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_schema_history_url ON schema_history(url);
CREATE INDEX idx_schema_history_version ON schema_history(version);
```

## Row Level Security (RLS)

Enable RLS for all tables:

```sql
ALTER TABLE scans ENABLE ROW LEVEL SECURITY;
ALTER TABLE urls ENABLE ROW LEVEL SECURITY;
ALTER TABLE suggestions ENABLE ROW LEVEL SECURITY;
ALTER TABLE schema_history ENABLE ROW LEVEL SECURITY;

-- Example policy: Allow authenticated users to read/write
CREATE POLICY "Allow authenticated users" ON scans
  FOR ALL USING (auth.role() = 'authenticated');

CREATE POLICY "Allow authenticated users" ON urls
  FOR ALL USING (auth.role() = 'authenticated');

CREATE POLICY "Allow authenticated users" ON suggestions
  FOR ALL USING (auth.role() = 'authenticated');

CREATE POLICY "Allow authenticated users" ON schema_history
  FOR ALL USING (auth.role() = 'authenticated');
```

## Usage Example

### Storing validation results:

```javascript
// After running csv-schema-validator.js --output results.json
const results = JSON.parse(fs.readFileSync('results.json'));

// Create scan record
const scan = await supabase
  .from('scans')
  .insert({
    agent: 'validator',
    total_urls: results.length,
    valid_count: results.filter(r => r.valid).length
  })
  .select()
  .single();

// Store URL results
for (const result of results) {
  await supabase
    .from('urls')
    .insert({
      scan_id: scan.id,
      url: result.url,
      schema_found: result.schemaFound,
      schema_type: result.schemaType ? result.schemaType.split(', ') : [],
      valid: result.valid,
      missing_fields: result.missingFields,
      warnings: result.warnings,
      validator_links: result.validatorLinks,
      page_analysis: result.pageAnalysis
    });
}
```

### Storing enhancement suggestions:

```javascript
// After running schema-enhancer.js
const enhancements = JSON.parse(fs.readFileSync('enhanced-schemas.json'));

// Find URL record
const urlRecord = await supabase
  .from('urls')
  .select('id')
  .eq('url', enhancement.url)
  .single();

// Store suggestion
await supabase
  .from('suggestions')
  .insert({
    url_id: urlRecord.id,
    proposed_json: enhancement.enhancedSchemas[0],
    added_fields: enhancement.addedFields,
    notes: enhancement.notes,
    version: 1
  });
```

## Migration Script

Create a migration file: `supabase/migrations/001_schema_tools.sql`

```sql
-- Run this migration in Supabase SQL Editor

BEGIN;

-- Create scans table
CREATE TABLE IF NOT EXISTS scans (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  timestamp TIMESTAMPTZ DEFAULT NOW(),
  agent VARCHAR(50) NOT NULL,
  total_urls INTEGER DEFAULT 0,
  valid_count INTEGER DEFAULT 0,
  invalid_count INTEGER DEFAULT 0,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create urls table
CREATE TABLE IF NOT EXISTS urls (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  scan_id UUID REFERENCES scans(id) ON DELETE CASCADE,
  url TEXT NOT NULL,
  schema_found BOOLEAN DEFAULT FALSE,
  schema_type TEXT[],
  valid BOOLEAN DEFAULT FALSE,
  missing_fields TEXT[],
  warnings TEXT[],
  error TEXT,
  validator_links JSONB,
  page_analysis JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create suggestions table
CREATE TABLE IF NOT EXISTS suggestions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  url_id UUID REFERENCES urls(id) ON DELETE CASCADE,
  scan_id UUID REFERENCES scans(id) ON DELETE CASCADE,
  proposed_json JSONB NOT NULL,
  original_json JSONB,
  added_fields TEXT[],
  notes TEXT[],
  version INTEGER DEFAULT 1,
  applied BOOLEAN DEFAULT FALSE,
  applied_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_scans_timestamp ON scans(timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_scans_agent ON scans(agent);
CREATE INDEX IF NOT EXISTS idx_urls_scan_id ON urls(scan_id);
CREATE INDEX IF NOT EXISTS idx_urls_url ON urls(url);
CREATE INDEX IF NOT EXISTS idx_urls_valid ON urls(valid);
CREATE INDEX IF NOT EXISTS idx_urls_schema_type ON urls USING GIN(schema_type);
CREATE INDEX IF NOT EXISTS idx_suggestions_url_id ON suggestions(url_id);
CREATE INDEX IF NOT EXISTS idx_suggestions_scan_id ON suggestions(scan_id);
CREATE INDEX IF NOT EXISTS idx_suggestions_applied ON suggestions(applied);

COMMIT;
```

## Notes

- This schema is optional and can be implemented later
- Supabase integration would require adding `@supabase/supabase-js` dependency
- RLS policies should be customized based on your security requirements
- Consider adding a `users` table and foreign key relationships if multi-user support is needed

