
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Event Schema Generator v3 - FINAL (Address Fixed)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; background: #f8f8f8; }
    h1 { font-size: 1.5rem; }
    textarea { width: 100%; height: 300px; margin-top: 1rem; }
    select, input[type="file"] { margin-top: 1rem; padding: 0.5rem; }
    button { margin-top: 1rem; padding: 0.5rem 1rem; font-size: 1rem; }
    pre { background: #fff; padding: 1rem; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Event Schema Generator v3 - FINAL (Address Fixed)</h1>
  <p><strong>Filename:</strong> event-schema-generator-v3-FINAL-address-fixed.html</p>
  <p>Upload a CSV file of events:</p>
  <input type="file" id="csvFile" accept=".csv" />

  <div id="categoryFilterContainer" style="display:none;">
    <p>Select category to generate schema for:</p>
    <select id="categoryFilter"></select>
    <button onclick="generateSchema()">Generate Schema</button>
  </div>

  <h2>Generated JSON-LD Schema</h2>
  <pre id="output"></pre>
<button onclick="copyToClipboard()">Copy to Clipboard</button>
<script>
  function copyToClipboard() {
    const text = document.getElementById('output').textContent;
    navigator.clipboard.writeText(text).then(function() {
      alert('Schema copied to clipboard!');
    }, function(err) {
      alert('Failed to copy text: ', err);
    });
  }
</script>


  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    let events = [];

    document.getElementById('csvFile').addEventListener('change', function(e) {
      Papa.parse(e.target.files[0], {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          events = results.data;
          
    const categories = [...new Set(
      events.map(e => (e['Category'] || '').split(',')[0].trim()).filter(Boolean)
    )];
    
          const filterSelect = document.getElementById('categoryFilter');
          filterSelect.innerHTML = '<option value="__ALL__">All Categories</option>';
          categories.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = c;
            filterSelect.appendChild(opt);
          });
          document.getElementById('categoryFilterContainer').style.display = 'block';
        }
      });
    });

    
function parseAddress(locationAddressRaw) {
  if (!locationAddressRaw || typeof locationAddressRaw !== "string") return {
    "@type": "PostalAddress",
    "addressCountry": "GB"
  };

  const parts = locationAddressRaw.split(",").map(p => p.trim()).filter(Boolean).reverse();
  const address = { "@type": "PostalAddress" };

  for (let i = 0; i < parts.length; i++) {
    const part = parts[i];

    if (!address.addressCountry && /^(United Kingdom|UK)$/i.test(part)) {
      address.addressCountry = "GB";
    } else if (!address.postalCode && /^[A-Z]{1,2}\d[A-Z\d]?\s*\d[A-Z]{2}$/i.test(part)) {
      address.postalCode = part.toUpperCase();
    } else if (!address.addressRegion) {
      address.addressRegion = part;
    } else if (!address.addressLocality) {
      address.addressLocality = part;
    } else if (!address.streetAddress) {
      address.streetAddress = part;
    }
  }

  if (!address.addressCountry) address.addressCountry = "GB";
  return address;
}

function generateSchema() {
      const selectedCategory = document.getElementById('categoryFilter').value;
      const today = new Date().toISOString().split('T')[0];
      const filtered = events.filter(e =>
        (selectedCategory === "__ALL__" || (e['Category'] || '').split(',')[0].trim() === selectedCategory) &&
        e['Start_Date'] >= today &&
        e['Workflow_State'] === 'Published'
      );

      const itemList = {
        "@type": "ItemList",
        "name": selectedCategory + " Events",
        "itemListElement": filtered.map((event, i) => ({
          "@type": "ListItem",
          "position": i + 1,
          "url": event['Event_URL']
        }))
      };

      
const eventList = filtered.map(event => ({
  "@type": "Event",
  "name": event['Event_Title'],
  "startDate": event['Start_Date'],
  "endDate": event['End_Date'],
  "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
  "eventStatus": "https://schema.org/EventScheduled",
  "image": event['Event_Image'],
  "organizer": {
    "@type": "Organization",
    "name": "Alan Ranger Photography",
    "logo": "https://images.squarespace-cdn.com/content/v1/5013f4b2c4aaa4752ac69b17/b859ad2b-1442-4595-b9a4-410c32299bf8/ALAN+RANGER+photography+LOGO+BLACK.+switched+small.png?format=1500w",
    "url": "https://www.alanranger.com"
  },
  "location": {
    "@type": "Place",
    "name": event['Location_Business_Name'],
    "address": parseAddress(event['Location_Address'])
  },
  "performer": {
    "@type": "Person",
    "name": "Alan Ranger"
  },
  "offers": {
    "@type": "Offer",
    "price": "0.00",
    "priceCurrency": "GBP",
    "availability": "https://schema.org/InStock",
    "url": event['Event_URL'],
    "validFrom": event['Start_Date']
  },
  "description": event['Excerpt'],
  "url": event['Event_URL']
}));


      const fullSchema = {
        "@context": "https://schema.org",
        "@graph": [itemList, ...eventList]
      };

      const json = JSON.stringify(fullSchema, null, 2);
      const scriptEl = document.createElement('script');
      scriptEl.type = 'application/ld+json';
      scriptEl.textContent = json;
      document.getElementById('output').textContent = scriptEl.outerHTML;
    }
  </script>
</body>
</html>
